name: Deploy Development

on:
  push:
    branches: [develop]
  workflow_dispatch:

env:
  ENVIRONMENT: development

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: development
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install -r backend/requirements.txt
          cd frontend && npm ci
      
      - name: Lint backend
        run: |
          pip install pylint
          pylint backend/routers --disable=all --enable=E,F --exit-zero || true
      
      - name: Lint frontend
        run: |
          cd frontend && npm run lint || true
      
      - name: Run backend tests
        run: |
          cd backend && pytest -v --tb=short || true
      
      - name: Run frontend tests
        run: |
          cd frontend && npm test -- --coverage --watchAll=false || true
      
      - name: Build frontend
        run: |
          cd frontend && npm run build
        env:
          REACT_APP_API_URL: https://racket-hero-dev.railway.app/api
          REACT_APP_ENVIRONMENT: development
          CI: false
      
      - name: Deploy to Railway Dev
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN_DEV }}
        run: |
          npm install -g @railway/cli
          echo "racket-hero-dev" | railway link -p racket-hero-dev -e development
          railway up --detach
      
      - name: Wait for deployment
        run: sleep 30
      
      - name: Health check
        run: |
          for i in {1..5}; do
            status=$(curl -s -o /dev/null -w "%{http_code}" https://racket-hero-dev.railway.app/health)
            if [ $status -eq 200 ]; then
              echo "‚úÖ Health check passed"
              exit 0
            fi
            echo "‚è≥ Waiting... (attempt $i/5)"
            sleep 10
          done
          echo "‚ùå Health check failed"
          exit 1
      
      - name: Notify Slack (Dev Deploy)
        if: success()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "text": "üöÄ Dev deployment successful",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Dev Environment Deployed*\n‚úÖ Status: Healthy"
                  }
                }
              ]
            }
      
      - name: Notify Slack (Failure)
        if: failure()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "text": "‚ùå Dev deployment failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Dev Deployment Failed*\n‚ùå Check logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
                }
              ]
            }
