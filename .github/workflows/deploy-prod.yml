name: Deploy Production

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  ENVIRONMENT: production

jobs:
  deploy-prod:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install -r backend/requirements.txt
          cd frontend && npm ci
      
      - name: Run comprehensive tests
        run: |
          cd backend && pytest -v --cov=routers
          cd ../frontend && npm test -- --coverage --watchAll=false
      
      - name: Security audit
        run: |
          pip install bandit
          bandit -r backend -f json -o bandit-report.json || true
          npm audit --audit-level=moderate || true
      
      - name: Build frontend
        run: |
          cd frontend && npm run build
        env:
          REACT_APP_API_URL: https://racket-hero.app/api
          REACT_APP_ENVIRONMENT: production
          CI: false
      
      - name: Create database backup
        env:
          DATABASE_URL: ${{ secrets.PROD_DATABASE_URL }}
        run: |
          cd backend
          python -c "from backup_manager import BackupManager; BackupManager().create_backup()"
      
      - name: Deploy to Railway Production
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN_PROD }}
        run: |
          npm install -g @railway/cli
          railway link --project racket-hero
          railway up -e production
      
      - name: Wait for deployment stability
        run: sleep 40
      
      - name: Health check production
        run: |
          max_attempts=10
          attempt=1
          until curl -f https://racket-hero.app/health; do
            if [ $attempt -eq $max_attempts ]; then
              echo "❌ Health check failed after $max_attempts attempts"
              exit 1
            fi
            echo "⏳ Attempt $attempt/$max_attempts - waiting for health check..."
            sleep 10
            ((attempt++))
          done
          echo "✅ Production health check passed"
      
      - name: Smoke tests production
        run: |
          echo "Testing API endpoint..."
          curl -f https://racket-hero.app/api/ || true
          echo "Testing frontend..."
          curl -f https://racket-hero.app/ || true
      
      - name: Verify database connectivity
        run: |
          curl -f https://racket-hero.app/health || exit 1
      
      - name: Create GitHub release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: release-${{ github.run_number }}
          release_name: Production Release ${{ github.run_number }}
          body: |
            ## Changes in this Release
            - Deployed from commit ${{ github.sha }}
            - Branch: main
            
            ## Deployment Info
            - Environment: Production
            - Time: ${{ github.event.head_commit.timestamp }}
          draft: false
          prerelease: false
      
      - name: Post deployment success
        run: |
          echo "### ✅ Production Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: Production" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: https://racket-hero.app" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "### ❌ Production Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "Immediate action required!" >> $GITHUB_STEP_SUMMARY
